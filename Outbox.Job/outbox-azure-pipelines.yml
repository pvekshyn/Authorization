trigger:
  branches:
    include:
    - main
  paths:
    include:
    - Outbox.Job

pool: 
  vmImage: ubuntu-latest

stages:
  - stage: Build
    displayName: 'Build and Push'
    variables:
      buildPlatform: 'Any CPU'
      buildConfiguration: 'Release'
      dotNetFramework: 'net6.0'
      targetRuntime: 'linux-x64'
      hostProject: 'Outbox.Job/src/Outbox.Job.Host/Outbox.Job.Host.csproj'
    jobs:
      - job: Build
        displayName: 'Build'
        steps:
        - task: DotNetCoreCLI@2
          displayName: 'Build'
          inputs:
            command: 'build'
            projects: $(hostProject)
            arguments: '--configuration $(buildConfiguration)'

        - task: DotNetCoreCLI@2
          displayName: 'Dotnet publish'
          inputs:
            command: 'publish'
            publishWebProjects: false 
            projects: $(hostProject)
            nobuild: true
            arguments: '--configuration $(BuildConfiguration) --framework $(dotNetFramework) --runtime $(targetRuntime) --self-contained --output $(Build.ArtifactStagingDirectory)'
        
        - task: PublishPipelineArtifact@1
          displayName: 'Publish Project Artifact'
          inputs:
            targetPath: $(build.artifactStagingDirectory)
            artifact: 'projectDrop'
            publishLocation: pipeline
        
        - task: Docker@2
          displayName: Build and push an image to container registry
          inputs:
            command: buildAndPush
            repository: outbox-job
            Dockerfile: $(build.artifactStagingDirectory)/Outbox.Job.Host/Dockerfile
            containerRegistry: pvauthorizationcr-sc